# Install and Configure Archiver

The SAPS Archiver component is responsible to collect data and metadata generated by tasks whose processing have either finished or failed. To this end, the Archive interacts with the SAPS Service Catalog, temporary and permanent storage pools.
  
## Dependencies

In an apt-based Linux distro, type the below commands to install the Archiver dependencies.

```bash
sudo apt-get update
sudo apt-get install openjdk-8-jdk
sudo apt-get -y install maven
sudo apt-get -y install git
sudo apt install python-swiftclient
sudo apt-get install -y nfs-kernel-server
```

In addition to above Linux packages, the Archiver also depends on three codebases: 1) ```fogbow-mono-manager```; 2) ```fogbow-mono-cli```; and 3) the own ```saps-engine``` repository (which holds the Archive code). To fetch and compile the source code of these repositories, follow the below steps:

```
# fogbow-mono-manager repository
git clone https://github.com/fogbow/fogbow-mono-manager.git
cd fogbow-mono-manager
git checkout develop
mvn install -Dmaven.test.skip=true

# fogbow-mono-cli repository
git clone https://github.com/fogbow/fogbow-mono-cli.git
cd fogbow-mono-cli
git checkout develop
mvn install -Dmaven.test.skip=true

# saps-engine repository
git clone https://github.com/ufcg-lsd/saps-engine
cd saps-engine
git checkout develop
mvn install -Dmaven.test.skip=true
```

## Configure

The first part of SAPS Archiver configuration deals with the setup of the NFS server temporary storage. Before starting the NFS daemon, please choose an directory, ```$nfs_server_folder_path```, in your machine local file system. The NFS daemon will hold the exported files within this directory. Below commands setup the NFS server:

```
mkdir -p $nfs_server_folder_path
echo "$nfs_server_folder_path *(rw,insecure,no_subtree_check,async,no_root_squash)" >> /etc/exports
sudo service nfs-kernel-server restart
```

## Configure

The Archiver configuration file (```archiver.conf```) customize this component to interact with other componenents, including the SAPS Catalog, the temporary and permanent storages.

```
##### Archiver properties #####
# Time sleep to run the archiving routine (default = 300)
saps_execution_period_archiver=300
# Time sleep to run the failed task cleanup routine (default = 30)
saps_execution_period_garbage_collector=30
# Debug mode (default = true) 
# When executing in debug mode, the output generated by failed tasks are also kept in the permanent storage
saps_execution_debug_mode=true

##### Catalog #####
# URL prefix (default = jdbc:postgresql://)
datastore_url_prefix=jdbc:postgresql://
# IP address
datastore_ip=$catalog_ip_address
# Port (default = 5432)
datastore_port=5432
# DB name
datastore_name=$catalog_db_name
# Driver (default = org.postgresql.Driver)
datastore_driver=org.postgresql.Driver
# Username
datastore_username=$catalog_user
#Password
datastore_password=$catalog_passwd

##### Temporary Storage (NFS) #####
# Path mounted by the client
saps_export_path=$nfs_server_folder_path

##### Permanent storage (Swift) #####
# Folder prefix for to archive failed tasks case debug mode is true (default = trash)
swift_folder_prefix_debug_failed_tasks=trash
# Folder prefix for to archive success tasks (default = archiver)
swift_folder_prefix=$swift_folder_prefix=archiver
# Container name
swift_container_name=$swift_container_name
# Username
swift_username=$openstack_username
# Password
swift_password=$openstack_password
# Tenant or project name
swift_tenant_name=$openstack_project_name
# Identity URL + version (e.g. https://<domain>:5000/v1)
swift_auth_url=$openstack_identity_url

##### Fogbow Keystone #####
# Project ID
fogbow.keystonev3.project.id=$openstack_project_id
# User ID
fogbow.keystonev3.user.id=$openstack_user_id
# Password
fogbow.keystonev3.password=$openstack_password
# Identity URL (e.g. https://<domain>:5000)
fogbow.keystonev3.auth.url=$openstack_identity_url
# Object Store URL (e.g. https://<domain>:8080/swift/v1)
fogbow.keystonev3.swift.url=$openstack_object_store_url
# Token update period (default = 1800000)
fogbow.keystonev3.swift.token.update.period=1800000

##### Fogbow CLI #####
# Fogbow CLI folder path
fogbow_cli_path=$fogbow_mono_cli_folder_path
```

## Run
Once the configuration file is customized, below command are used to start and stop the Archiver component.

```
# Start command
bash bin/start-archiver
```

```
# Stop command
bash bin/stop-archiver
```
